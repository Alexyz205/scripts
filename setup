#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &> /dev/null && pwd)"
source "$SCRIPT_DIR/logs"
source "$SCRIPT_DIR/utils"

export XDG_CONFIG_HOME="$HOME/.config"

# Process help option first
if [[ "$1" == "--help" ]]; then
    section_header "Dotfiles Setup"
    echo "Usage: setup [--help]"
    echo "This script creates necessary directories and symlinks for dotfiles configuration."
    echo
    echo "${INFO_ICON} Configuration directories will be created at:"
    echo "  ${BOLD}$XDG_CONFIG_HOME${RESET}"
    echo
    echo "${INFO_ICON} The following configurations will be linked:"
    echo "  ${BOLD}ghostty${RESET}       - Modern terminal emulator"
    echo "  ${BOLD}nix${RESET}           - Nix package manager"
    echo "  ${BOLD}tmux${RESET}          - Terminal multiplexer"
    echo "  ${BOLD}nvim${RESET}          - Neovim text editor"
    echo "  ${BOLD}starship${RESET}      - Cross-shell prompt"
    echo "  ${BOLD}zsh${RESET}           - Z shell configuration"
    echo "  ${BOLD}bash${RESET}          - Bash shell configuration"
    exit 0
fi

section_header "Dotfiles Setup"

log "Configuration will be set up in ${BOLD}$HOME${RESET} and ${BOLD}$XDG_CONFIG_HOME${RESET}"

# Get dotfiles directory
if [ -z "$DOTFILES_DIR" ]; then
    DOTFILES_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
    log_warning "DOTFILES_DIR wasn't set, using: ${BOLD}$DOTFILES_DIR${RESET}"
else
    log "Using dotfiles directory: ${BOLD}$DOTFILES_DIR${RESET}"
fi

# Define common directories to create
common_directories=(
    $XDG_CONFIG_HOME
)

# Define symlinks to create (source:target)
common_items=(
  "ghostty:$XDG_CONFIG_HOME/ghostty"
  "nix:$XDG_CONFIG_HOME/nix"
  "tmux/.tmux.conf:$HOME/.tmux.conf"
  "tmux/.tmux:$HOME/.tmux"
  "nvim:$XDG_CONFIG_HOME/nvim"
  "starship.toml:$XDG_CONFIG_HOME/starship.toml"
  "shell/zsh:$XDG_CONFIG_HOME/zsh"
  "shell/zsh/.zprofile:$HOME/.zprofile"
  "shell/zsh/.zshrc:$HOME/.zshrc"
  "shell/bash/.bashrc:$HOME/.bashrc"
)

log_progress "Creating required directories"
create_directories "${common_directories[@]}"

section_header "Creating Symlinks"

log_progress "Setting up configuration symlinks"
create_symlinks "${common_items[@]}"

section_header "Setup Complete"
log_complete "Dotfiles have been successfully configured!"
echo
echo "${SUCCESS_ICON} The following configurations have been set up:"
echo "  ${BOLD}Shell${RESET}       - ZSH and Bash configurations"
echo "  ${BOLD}Terminal${RESET}    - Ghostty terminal and tmux multiplexer"
echo "  ${BOLD}Editor${RESET}      - Neovim configuration"
echo "  ${BOLD}Prompt${RESET}      - Starship cross-shell prompt"
echo "  ${BOLD}Package Mgr${RESET} - Nix configuration"
echo
echo "${INFO_ICON} You may need to restart your shell or terminal to see the changes"
